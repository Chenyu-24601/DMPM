name: Notify DMPM Skill Updates

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'DMPM/skills/**'

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Get changed skills
        id: changes
        run: |
          # è·å–å˜æ›´çš„æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep "DMPM/skills/" || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No skill changes"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # æå–å˜æ›´çš„ Skill åç§°
          SKILLS=$(echo "$CHANGED_FILES" | cut -d'/' -f3 | sort -u | tr '\n' ', ' | sed 's/,$//')
          echo "skills=$SKILLS" >> $GITHUB_OUTPUT

          # è·å–æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # è·å–æäº¤è€…
          AUTHOR=$(git log -1 --pretty=%an)
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT

      - name: Display changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "Changed Skills: ${{ steps.changes.outputs.skills }}"
          echo "Author: ${{ steps.changes.outputs.author }}"
          echo "Commit Message:"
          echo "${{ steps.changes.outputs.commit_msg }}"

      # å¯é€‰ï¼šå‘é€åˆ°é£ä¹¦
      # - name: Send to Feishu
      #   if: steps.changes.outputs.has_changes == 'true'
      #   run: |
      #     curl -X POST ${{ secrets.FEISHU_WEBHOOK_URL }} \
      #       -H 'Content-Type: application/json' \
      #       -d '{
      #         "msg_type": "text",
      #         "content": {
      #           "text": "ğŸ‰ DMPM Skills æ›´æ–°\n\næ›´æ–°è€…: ${{ steps.changes.outputs.author }}\nå˜æ›´çš„ Skills: ${{ steps.changes.outputs.skills }}\n\nè®°å¾—è¿è¡Œä»¥ä¸‹å‘½ä»¤è·å–æœ€æ–°ç‰ˆæœ¬ï¼š\ngit pull\n./DMPM/scripts/sync-from-team.sh"
      #         }
      #       }'

      # å¯é€‰ï¼šå‘é€åˆ°ä¼ä¸šå¾®ä¿¡
      # - name: Send to WeCom
      #   if: steps.changes.outputs.has_changes == 'true'
      #   run: |
      #     curl -X POST ${{ secrets.WECOM_WEBHOOK_URL }} \
      #       -H 'Content-Type: application/json' \
      #       -d '{
      #         "msgtype": "markdown",
      #         "markdown": {
      #           "content": "## ğŸ‰ DMPM Skills æ›´æ–°\n\n**æ›´æ–°è€…**: ${{ steps.changes.outputs.author }}\n**å˜æ›´çš„ Skills**: ${{ steps.changes.outputs.skills }}\n\nè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤è·å–æœ€æ–°ç‰ˆæœ¬ï¼š\n```bash\ngit pull\n./DMPM/scripts/sync-from-team.sh\n```"
      #         }
      #       }'

      # å¯é€‰ï¼šåˆ›å»º GitHub Release
      # - name: Create Release
      #   if: steps.changes.outputs.has_changes == 'true' && contains(github.event.head_commit.message, 'release')
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     tag_name: dmpm-${{ github.run_number }}
      #     release_name: DMPM Skills Update ${{ github.run_number }}
      #     body: |
      #       ## Skills æ›´æ–°
      #
      #       **æ›´æ–°è€…**: ${{ steps.changes.outputs.author }}
      #       **å˜æ›´çš„ Skills**: ${{ steps.changes.outputs.skills }}
      #
      #       ### æäº¤ä¿¡æ¯
      #       ${{ steps.changes.outputs.commit_msg }}
      #     draft: false
      #     prerelease: false
